<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 麻將戰績統計表 - AI 增強版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            -webkit-font-smoothing: antialiased;
        }

        .card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid #f3f4f6;
            position: relative;
        }

        .calendar-day:hover {
            background-color: #f9fafb;
        }

        .win-bg { background-color: #fef2f2 !important; }
        .lose-bg { background-color: #f0fdf4 !important; }
        
        .win-text { color: #e11d48; font-weight: 700; }
        .lose-text { color: #16a34a; font-weight: 700; }

        #modalBackdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        input, select {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px;
            width: 100%;
        }

        /* 加載動畫 */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- 標題區 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-black text-gray-800">2026 麻將戰績統計表</h1>
            <p class="text-gray-500 mt-2">記錄每一場的輸贏，掌握年度手氣</p>
        </header>

        <!-- 數據總覽 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="card p-5 text-center border-t-4 border-red-500">
                <div class="text-gray-400 text-sm font-bold mb-1">總贏錢</div>
                <div id="totalWin" class="text-2xl font-bold text-red-600">NT$ 0</div>
            </div>
            <div class="card p-5 text-center border-t-4 border-green-500">
                <div class="text-gray-400 text-sm font-bold mb-1">總輸錢</div>
                <div id="totalLose" class="text-2xl font-bold text-green-600">NT$ 0</div>
            </div>
            <div class="card p-5 text-center border-t-4 border-gray-800 bg-gray-800">
                <div class="text-gray-300 text-sm font-bold mb-1">年度淨損益</div>
                <div id="netBalance" class="text-2xl font-bold text-white">NT$ 0</div>
            </div>
        </div>

        <!-- ✨ AI 分析區塊 -->
        <div class="card p-6 mb-8 border-2 border-blue-200 bg-blue-50/50">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-blue-800 flex items-center gap-2">
                    <span>✨ AI 牌運分析助手</span>
                </h3>
                <button onclick="generateAIReport()" id="aiBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded-full transition-all flex items-center gap-2">
                    生成戰報分析 ✨
                </button>
            </div>
            <div id="aiResponse" class="text-sm text-blue-700 leading-relaxed italic">
                點擊上方按鈕，讓 Gemini 分析你目前的戰績數據...
            </div>
        </div>

        <!-- 日曆區塊 -->
        <div class="card overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 flex justify-between items-center border-b">
                <button onclick="changeMonth(-1)" class="text-gray-600 hover:text-black font-bold">上個月</button>
                <h2 id="currentMonthDisplay" class="text-xl font-bold text-gray-800">2026年 1月</h2>
                <button onclick="changeMonth(1)" class="text-gray-600 hover:text-black font-bold">下個月</button>
            </div>

            <div class="grid grid-cols-7 text-center bg-gray-100 font-bold text-gray-500 text-sm">
                <div class="py-2">日</div>
                <div class="py-2">一</div>
                <div class="py-2">二</div>
                <div class="py-2">三</div>
                <div class="py-2">四</div>
                <div class="py-2">五</div>
                <div class="py-2">六</div>
            </div>
            
            <div id="calendarGrid" class="grid grid-cols-7 bg-white">
                <!-- 日期將由 JS 注入 -->
            </div>
        </div>
    </div>

    <!-- 輸入視窗 -->
    <div id="modalBackdrop" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-xl overflow-hidden">
            <div class="bg-gray-800 px-6 py-4 flex justify-between items-center text-white">
                <h3 id="modalDateTitle" class="font-bold">新增戰績</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">✕</button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">底 / 台</label>
                    <select id="stakeType">
                        <option value="30/10">30 / 10</option>
                        <option value="50/20">50 / 20</option>
                        <option value="100/20">100 / 20</option>
                        <option value="other">自訂</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">打了幾將</label>
                        <input type="number" id="rounds" step="0.5" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">今日損益</label>
                        <input type="number" id="amount" placeholder="贏+, 輸-">
                    </div>
                </div>

                <div class="pt-2">
                    <button onclick="saveRecord()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition-colors">儲存紀錄</button>
                    <button onclick="deleteRecord()" id="deleteBtn" class="w-full mt-3 text-red-500 text-sm font-bold hover:underline hidden">刪除此筆紀錄</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // 執行環境會自動提供
        let currentYear = 2026;
        let currentMonth = 0; 
        let selectedDateKey = "";
        let records = JSON.parse(localStorage.getItem('mahjong_records_2026_simple')) || {};

        const calendarGrid = document.getElementById('calendarGrid');
        const monthDisplay = document.getElementById('currentMonthDisplay');
        const modal = document.getElementById('modalBackdrop');

        function init() {
            renderCalendar();
            updateStats();
        }

        // --- Gemini API 整合 ---
        async function fetchGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "你是一位幽默風確的麻將大師。你會根據用戶提供的麻將戰績數據進行短評。請保持回答在 100 字以內。使用繁體中文。" }] }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('API Error');
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            return "暫時無法連線到麻將大師，請稍後再試。";
        }

        async function generateAIReport() {
            const aiBtn = document.getElementById('aiBtn');
            const aiResponse = document.getElementById('aiResponse');
            
            // 計算數據摘要供 AI 使用
            let winCount = 0;
            let loseCount = 0;
            let totalWinAmount = 0;
            let totalLoseAmount = 0;
            Object.values(records).forEach(r => {
                if (r.amount > 0) { winCount++; totalWinAmount += r.amount; }
                else if (r.amount < 0) { loseCount++; totalLoseAmount += Math.abs(r.amount); }
            });

            const prompt = `這是我的 2026 年麻將戰績摘要：總共贏了 ${winCount} 次（共 NT$ ${totalWinAmount}），輸了 ${loseCount} 次（共 NT$ ${totalLoseAmount}）。淨損益是 NT$ ${totalWinAmount - totalLoseAmount}。請以麻將大師的口吻給我一段簡短的評價。`;

            aiBtn.disabled = true;
            aiBtn.innerHTML = '<span class="loader"></span> 分析中...';
            aiResponse.innerText = "正在分析你的牌運數據...";

            const analysis = await fetchGemini(prompt);
            
            aiResponse.innerText = analysis;
            aiBtn.disabled = false;
            aiBtn.innerHTML = '生成戰報分析 ✨';
        }

        // --- 核心邏輯 ---

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            monthDisplay.innerText = `${currentYear}年 ${currentMonth + 1}月`;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day bg-gray-50/50';
                calendarGrid.appendChild(empty);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                if (records[dateKey]) {
                    const amt = records[dateKey].amount;
                    if (amt > 0) dayEl.classList.add('win-bg');
                    else if (amt < 0) dayEl.classList.add('lose-bg');
                }

                dayEl.innerHTML = `<span class="text-xs text-gray-400 absolute top-1 left-2">${day}</span>`;
                
                if (records[dateKey]) {
                    const amt = records[dateKey].amount;
                    const displayAmt = amt > 0 ? `+${amt}` : amt;
                    dayEl.innerHTML += `<span class="text-sm ${amt >= 0 ? 'win-text' : 'lose-text'}">${displayAmt}</span>`;
                }

                dayEl.onclick = () => openModal(dateKey);
                calendarGrid.appendChild(dayEl);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function openModal(dateKey) {
            selectedDateKey = dateKey;
            document.getElementById('modalDateTitle').innerText = `${dateKey.replace(/-/g, '/')} 戰績`;
            
            const record = records[dateKey];
            if (record) {
                document.getElementById('stakeType').value = record.stakeType || '30/10';
                document.getElementById('rounds').value = record.rounds || '';
                document.getElementById('amount').value = record.amount || '';
                document.getElementById('deleteBtn').classList.remove('hidden');
            } else {
                document.getElementById('stakeType').value = '30/10';
                document.getElementById('rounds').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('deleteBtn').classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function saveRecord() {
            const stakeType = document.getElementById('stakeType').value;
            const rounds = parseFloat(document.getElementById('rounds').value) || 0;
            const amount = parseFloat(document.getElementById('amount').value) || 0;

            if (rounds === 0 && amount === 0) {
                delete records[selectedDateKey];
            } else {
                records[selectedDateKey] = { stakeType, rounds, amount };
            }

            localStorage.setItem('mahjong_records_2026_simple', JSON.stringify(records));
            closeModal();
            renderCalendar();
            updateStats();
        }

        function deleteRecord() {
            if (confirm('確定刪除紀錄？')) {
                delete records[selectedDateKey];
                localStorage.setItem('mahjong_records_2026_simple', JSON.stringify(records));
                closeModal();
                renderCalendar();
                updateStats();
            }
        }

        function updateStats() {
            let win = 0;
            let lose = 0;

            Object.values(records).forEach(rec => {
                const amt = parseFloat(rec.amount) || 0;
                if (amt > 0) win += amt;
                else if (amt < 0) lose += Math.abs(amt);
            });

            const net = win - lose;

            document.getElementById('totalWin').innerText = `NT$ ${win.toLocaleString()}`;
            document.getElementById('totalLose').innerText = `NT$ ${lose.toLocaleString()}`;
            
            const netEl = document.getElementById('netBalance');
            netEl.innerText = `${net >= 0 ? '+' : ''}NT$ ${net.toLocaleString()}`;
            if (net > 0) netEl.className = "text-2xl font-bold text-red-500";
            else if (net < 0) netEl.className = "text-2xl font-bold text-green-400";
            else netEl.className = "text-2xl font-bold text-white";
        }

        window.onload = init;
    </script>
</body>
</html>